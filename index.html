<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KOL Studio â€“ Editor + Viewer</title>
<style>
body{margin:0;font-family:sans-serif;background:#0e0e0e;color:#eee;display:flex;height:100vh;touch-action:none}
#ui{width:280px;background:#1b1b1b;padding:10px;display:flex;flex-direction:column;gap:8px}
#stageWrap{flex:1;display:flex;justify-content:center;align-items:center}
#stage{position:relative;width:640px;height:360px;background:#333;overflow:hidden}
#stage.fullscreen{position:fixed;inset:0;width:100vw;height:100vh;z-index:1000}
#stage.fit{object-fit:contain}
#stage.fill{object-fit:cover}
#stage.fullscreen{position:fixed;inset:0;width:100vw;height:100vh;z-index:1000}
.layer{position:absolute;cursor:move;user-select:none;touch-action:none}
input,button{background:#2a2a2a;color:#eee;border:1px solid #555;padding:6px}
button:hover{background:#3a3a3a}
.handle{width:10px;height:10px;background:#fff;position:absolute;right:-5px;bottom:-5px;cursor:nwse-resize}
#layers{font-size:12px}
</style>
</head>
<body>

<script>
// Viewer mode detection
const params = new URLSearchParams(location.search);
const viewerMode = params.has('view');
const autoFullscreen = params.has('fullscreen');
const autoPlayLock = params.has('autoplay');
const scaleMode = params.get('scale') || 'fit';
const liveChannel = params.get('live');
</script>

<div id="ui" data-ui>
  <b>KOL Studio</b>
  <input type="color" id="bgColor">
  <input type="file" id="fileInput" accept="image/*,video/*,.kol" multiple>
  <label>Kesto (sek): <input type="number" id="duration" value="5" min="1"></label>
  <button onclick="toggleFullscreen()">â›¶ Fullscreen</button>
  <button onclick="saveKOL()">ðŸ’¾ Tallenna .kol</button>
  <b>Layerit</b>
  <div id="layers"></div>
</div>

<script>
if(viewerMode){
  document.getElementById('ui').style.display='none';
  if(autoFullscreen){ setTimeout(()=>toggleFullscreen(),300); }
  if(autoPlayLock){ stage.addEventListener('click',e=>e.preventDefault()); }
}
}
</script>
</div>

<div id="stageWrap"><div id="stage"></div></div>
<script>
if(scaleMode==='fill') stage.classList.add('fill'); else stage.classList.add('fit');
</script>

<script>
const stage = document.getElementById('stage');
const layersDiv = document.getElementById('layers');
const bgColor = document.getElementById('bgColor');
const fileInput = document.getElementById('fileInput');

let layers = [];
let liveBC = liveChannel ? new BroadcastChannel('kol-live-'+liveChannel) : null;
if(liveBC){ liveBC.onmessage = e => load(e.data); }

bgColor.oninput = () => stage.style.background = bgColor.value;

fileInput.onchange = async e => {
  const files = [...e.target.files];
  for (const f of files) {
    if (f.name.endsWith('.kol')) {
      const txt = await f.text();
      load(JSON.parse(txt));
      continue;
    }

    const dataURL = await fileToDataURL(f);
    const el = f.type.startsWith('video') ? document.createElement('video') : document.createElement('img');
    el.dataset.name = f.name;
    el.src = dataURL;
    if (el.tagName === 'VIDEO') {
      el.autoplay = true;
      el.loop = true;
      el.muted = true;
      el.playsInline = true;
    }
    el.className = 'layer';
    el.style.left = '50px';
    el.style.top = '50px';
    el.style.width = '200px';
    addHandles(el);
    drag(el);
    stage.appendChild(el);
    layers.push(el);
  }
  refreshLayers();
};

function fileToDataURL(file){
  return new Promise(res=>{
    const r=new FileReader();
    r.onload=()=>res(r.result);
    r.readAsDataURL(file);
  });
}

function drag(el){
  let sx,sy,ox,oy;
  el.onpointerdown=e=>{
    ox=parseInt(el.style.left); oy=parseInt(el.style.top);
    sx=e.clientX; sy=e.clientY;
    el.setPointerCapture(e.pointerId);
    el.onpointermove=p=>{
      el.style.left = ox + (p.clientX-sx) + 'px'; broadcast();
      el.style.top  = oy + (p.clientY-sy) + 'px';
    };
    el.onpointerup=()=>el.onpointermove=null;
  };
}

function addHandles(el){
  const h=document.createElement('div');
  h.className='handle';
  el.appendChild(h);
  h.onpointerdown=e=>{
    e.stopPropagation();
    const w=el.offsetWidth; const h0=el.offsetHeight||el.offsetWidth; 
    const sx=e.clientX, sy=e.clientY;
    h.setPointerCapture(e.pointerId);
    h.onpointermove=p=>{
      el.style.width = w + (p.clientX-sx) + 'px'; broadcast();
      el.style.height = h0 + (p.clientY-sy) + 'px';
    };
    h.onpointerup=()=>h.onpointermove=null;
  };
};
}

function broadcast(){ if(liveBC) liveBC.postMessage(serialize()); }

function saveKOL(){
  const data = serialize();
  download(new Blob([JSON.stringify(data)],{type:'application/json'}),'projekti.kol');
}

function serialize(){
  return {
    bg: stage.style.background,
    stage:{ w: stage.style.width || '640px', h: stage.style.height || '360px' },
    layers: [...stage.children].map((l,i)=>({
      name: l.dataset.name || (l.tagName+' '+i),
      tag: l.tagName,
      src: l.src,
      x: l.style.left,
      y: l.style.top,
      w: l.style.width,
      h: l.style.height || 'auto'
    }))
  };
}

function load(d){
  stage.innerHTML=''; layers=[];
  stage.style.background=d.bg;
  if(d.stage){ stage.style.width=d.stage.w; stage.style.height=d.stage.h; }
  d.layers.forEach(o=>{
    const el=document.createElement(o.tag.toLowerCase());
    el.src=o.src;
    el.dataset.name=o.name;
    if(o.tag==='VIDEO'){
      el.autoplay=true; el.loop=true; el.muted=true; el.playsInline=true;
    }
    el.className='layer';
    el.style.left=o.x; el.style.top=o.y; el.style.width=o.w; if(o.h) el.style.height=o.h;
    addHandles(el); drag(el);
    stage.appendChild(el); layers.push(el); broadcast();(el);
  });
  refreshLayers();
}

function refreshLayers(){
  layersDiv.innerHTML='';
  layers.forEach((l,i)=>{
    const wrap=document.createElement('div');
    const name=document.createElement('input');
    name.value=l.dataset.name||('Layer '+i);
    name.oninput=()=>l.dataset.name=name.value;
    const btn=document.createElement('button');
    btn.textContent='Valitse';
    btn.onclick=()=>{layers.forEach(x=>x.style.zIndex=0);l.style.zIndex=10;};
    wrap.appendChild(name); wrap.appendChild(btn);
    layersDiv.appendChild(wrap);
  });
}

function toggleFullscreen(){
  stage.classList.toggle('fullscreen');
}

function download(blob,name){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=name;
  a.click();
}
</script>
</body>
</html>
